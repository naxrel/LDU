{
  "a87e49a6-ced1-4014-93c3-1e2f8804ceb2.png": {
    "text": "import os\nimport base64\nimport requests\nimport uuid\nimport hashlib \nimport json    \nfrom stegano import lsb\nfrom PySide6.QtWidgets import (\n    QWidget, QVBoxLayout, QHBoxLayout, QLabel,\n    QLineEdit, QPushButton, QMessageBox,\n    QListWidget, QListWidgetItem, QFileDialog,\n    QInputDialog, QFrame, QApplication, QDialog,\n    QSizePolicy, QListView, QTextEdit\n)\nfrom PySide6.QtGui import QFont, QColor, QPixmap\nfrom PySide6.QtCore import Qt, QSize, QTimer\nfrom datetime import datetime, timezone \n\n# Pastikan utils.py ada di satu folder yang sama\nfrom utils import CryptoEngine, vigenere_encrypt, vigenere_decrypt, encrypt_whitemist, decrypt_whitemist\n\nclass ChatPage(QWidget):\n    \n    # --- Palet Warna ---\n    COLOR_BACKGROUND = \"#1A1B2E\"\n    COLOR_PANE_LEFT = \"#272540\" \n    COLOR_PANE_RIGHT = \"#1A1B2E\"\n    COLOR_CARD_BG = \"#272540\"\n    COLOR_CARD = \"#3E3C6E\"     \n    COLOR_CARD_HOVER = \"#504E8A\" \n    COLOR_TEXT = \"#F0F0F5\"\n    COLOR_TEXT_SUBTLE = \"#A9A8C0\"\n    COLOR_GOLD = \"#D4AF37\"\n    COLOR_GOLD_HOVER = \"#F0C44F\"\n    COLOR_GOLD_PRESSED = \"#B8860B\"\n    COLOR_RED = \"#ed4956\"\n    COLOR_RED_HOVER = \"#ff7d6e\"\n    COLOR_RED_PRESSED = \"#e63946\"\n    COLOR_BUBBLE_SENT = \"#3C506E\" \n    COLOR_BUBBLE_RECV = \"#3E3C6E\"\n    # -------------------\n\n    def __init__(self, current_user, recipient_username, shared_password, message_manager, back_callback):\n        super().__init__()\n        self.current_user = current_user\n        self.recipient_username = recipient_username\n        self.message_manager = message_manager\n        self.back_callback = back_callback\n        \n        self.chat_id = self.message_manager.get_chat_id(self.current_user, self.recipient_username)\n        self.session_crypto = CryptoEngine(shared_password)\n        \n        self.api_url = \"https://morsz.azeroth.site/\"\n        self.MAX_FILE_SIZE = 2 * 1024 * 1024 # 2MB\n        \n        script_file_path = os.path.abspath(__file__)\n        script_dir = os.path.dirname(script_file_path)\n        base_project_dir = os.path.dirname(script_dir)\n\n        self.base_data_dir = os.path.join(base_project_dir, \"local_data\")\n        self.cache_dir = os.path.join(self.base_data_dir, \"user_caches\")\n        self.cache_file = os.path.join(self.cache_dir, f\"cache_{self.current_user}.json\")\n        self.message_cache = self.load_cache()\n        \n        self.temp_stegano_dir = os.path.join(self.base_data_dir, \"temp_stegano\")\n        self.temp_download_dir = os.path.join(self.base_data_dir, \"temp_downloads\")\n        self.temp_decrypted_dir = os.path.join(self.base_data_dir, \"temp_decrypted\")\n        \n        # [OPTIMASI] Set untuk melacak ID pesan yang SUDAH tampil di layar.\n        self.rendered_message_ids = set()\n        \n        for folder in [self.base_data_dir, self.cache_dir, self.temp_stegano_dir, self.temp_download_dir, self.temp_decrypted_dir]:\n            if not os.path.exists(folder):\n                os.makedirs(folder)\n\n        self.init_ui() \n        \n        # Refresh saat pertama kali masuk\n        QTimer.singleShot(0, self.refresh_chat_display)\n        \n        # Mulai polling data setiap 1 detik (1000ms)\n        self.poll_timer = QTimer(self)\n        self.poll_timer.timeout.connect(self.refresh_chat_display)\n        self.poll_timer.start(1000) \n\n    # --- Cache Functions ---\n    def get_message_id(self, metadata):\n        msg_type = metadata.get('type')\n        if msg_type == 'text':\n            return hashlib.md5(metadata.get('data', '').encode('utf-8')).hexdigest()\n        elif msg_type in ['stegano', 'file']:\n            return metadata.get('file_id')\n        return None\n\n    def load_cache(self):\n        if not os.path.exists(self.cache_file): return {}\n        try:\n            with open(self.cache_file, 'r', encoding='utf-8') as f:\n                return json.load(f)\n        except (json.JSONDecodeError, IOError): return {} \n\n    def save_to_cache(self, message_id, data_to_cache):\n        if not message_id: return\n        self.message_cache[message_id] = data_to_cache\n        try:\n            if not os.path.exists(self.cache_dir):\n                os.makedirs(self.cache_dir)\n            with open(self.cache_file, 'w', encoding='utf-8') as f:\n                json.dump(self.message_cache, f, indent=2, ensure_ascii=False)\n        except IOError as e: print(f\"Peringatan: Gagal menyimpan cache ke file: {e}\")\n    # -----------------------\n\n    def init_ui(self):\n        self.resize(700, 800) \n        self.setStyleSheet(f\"background-color: {self.COLOR_BACKGROUND};\")\n        layout = QVBoxLayout(self); layout.setContentsMargins(20, 20, 20, 20); layout.setSpacing(15)\n\n        top_bar_layout = QHBoxLayout()\n        back_btn = QPushButton(\"< Back\")\n        back_btn.setStyleSheet(self.button_style(\n            base=self.COLOR_RED, hover=self.COLOR_RED_HOVER, pressed=self.COLOR_RED_PRESSED, radius=10\n        ))\n        \n        back_btn.clicked.connect(self.handle_back_pressed)\n        back_btn.setFixedWidth(100)\n        \n        title = QLabel(f\"Chat with: {self.recipient_username}\")\n        title.setFont(QFont(\"Segoe UI\", 16, QFont.Bold))\n        title.setStyleSheet(f\"color: {self.COLOR_GOLD};\"); \n        title.setAlignment(Qt.AlignmentFlag.AlignCenter)\n        \n        top_bar_layout.addWidget(back_btn); top_bar_layout.addWidget(title)\n        \n        self.chat_display = QListWidget()\n        self.chat_display.setStyleSheet(f\"\"\"\n            QListWidget {{ \n                background-color: {self.COLOR_PANE_LEFT}; \n                border: 2px solid {self.COLOR_GOLD};\n                border-radius: 12px; \n                color: {self.COLOR_TEXT}; \n            }}\n        \"\"\")\n        self.chat_display.setSelectionMode(QListWidget.SelectionMode.NoSelection)\n        self.chat_display.setFocusPolicy(Qt.FocusPolicy.NoFocus)\n        self.chat_display.setVerticalScrollBarPolicy(Qt.ScrollBarPolicy.ScrollBarAsNeeded)\n        self.chat_display.setHorizontalScrollBarPolicy(Qt.ScrollBarPolicy.ScrollBarAlwaysOff)\n        \n        # --- [OPTIMASI SCROLL LAG] ---\n        self.chat_display.setVerticalScrollMode(QListWidget.ScrollMode.ScrollPerPixel)\n        self.chat_display.setUniformItemSizes(False)\n        self.chat_display.setLayoutMode(QListView.LayoutMode.Batched)\n        self.chat_display.setBatchSize(10)\n        self.chat_display.setWordWrap(False)\n        # -----------------------------\n        \n        self.chat_display.itemClicked.connect(self.on_chat_item_clicked)\n\n        input_bar_layout = QHBoxLayout()\n        self.attach_btn = QPushButton(\"ðŸ–¼ï¸ Gbr\"); self.attach_btn.setToolTip(\"Sembunyikan teks dari input ke dalam Gambar (.png)\")\n        self.attach_btn.setFont(QFont(\"Segoe UI\", 12)); \n        self.attach_btn.setStyleSheet(self.button_style(\n            base=self.COLOR_CARD, hover=self.COLOR_CARD_HOVER, pressed=self.COLOR_CARD_BG, radius=10\n        ))\n        self.attach_btn.setFixedSize(70, 45)\n        self.attach_btn.clicked.connect(self.handle_attach_image_stegano)\n\n        self.attach_file_btn = QPushButton(\"ðŸ“‚ File\"); \n        self.attach_file_btn.setToolTip(\"Enkripsi file (AES / White-Mist)\")\n        self.attach_file_btn.setFont(QFont(\"Segoe UI\", 12)); \n        self.attach_file_btn.setStyleSheet(self.button_style(\n            base=self.COLOR_CARD, hover=self.COLOR_CARD_HOVER, pressed=self.COLOR_CARD_BG, radius=10\n        ))\n        self.attach_file_btn.setFixedSize(70, 45)\n        self.attach_file_btn.clicked.connect(self.handle_attach_file) \n\n        self.message_input = QLineEdit(); self.message_input.setPlaceholderText(\"Ketik pesan...\")\n        self.message_input.setStyleSheet(self.input_style()) \n        self.message_input.returnPressed.connect(self.handle_send_message_super)\n\n        self.send_btn = QPushButton(\"Send Txt\"); self.send_btn.setToolTip(\"Kirim teks dengan Super Enkripsi (Vigenere -> White Mist -> AES Sesi)\")\n        self.send_btn.setFont(QFont(\"Segoe UI\", 11, QFont.Bold)); \n        self.send_btn.setStyleSheet(self.button_style(\n            base=self.COLOR_GOLD, hover=self.COLOR_GOLD_HOVER, pressed=self.COLOR_GOLD_PRESSED, \n            radius=22, text_color=self.COLOR_PANE_LEFT\n        ))\n        self.send_btn.setFixedSize(100, 45)\n        self.send_btn.clicked.connect(self.handle_send_message_super)\n\n        input_bar_layout.addWidget(self.attach_btn); input_bar_layout.addWidget(self.attach_file_btn)\n        input_bar_layout.addWidget(self.message_input); input_bar_layout.addWidget(self.send_btn)\n        layout.addLayout(top_bar_layout); layout.addWidget(self.chat_display); layout.addLayout(input_bar_layout)\n        \n    def handle_back_pressed(self):\n        if hasattr(self, 'poll_timer') and self.poll_timer.isActive():\n            self.poll_timer.stop()\n            print(\"ChatPage: Polling timer stopped.\")\n        self.back_callback()\n\n    def refresh_chat_display(self):\n        \"\"\"\n        Logika Refresh Cerdas: Hanya render ID pesan baru.\n        \"\"\"\n        all_messages = self.message_manager.load_messages(self.chat_id)\n        new_messages_found = False\n\n        for msg_data in all_messages:\n            msg_id = self.get_message_id(msg_data)\n            \n            if msg_id and msg_id not in self.rendered_message_ids:\n                align = \"sent\" if msg_data['sender'] == self.current_user else \"received\"\n                cached_data = self.message_cache.get(msg_id)\n                \n                self.add_message_to_display(align, msg_data, cached_data)\n                \n                self.rendered_message_ids.add(msg_id)\n                new_messages_found = True\n        \n        if new_messages_found:\n            QApplication.processEvents()\n            self.chat_display.scrollToBottom()\n\n    def handle_send_message_super(self):\n        message_text = self.message_input.text() \n        if not message_text: return\n        user_key, ok = QInputDialog.getText(self, \"Kunci Super Enkripsi\", \"Masukkan Kunci (untuk Vigenere + White Mist):\")\n        if not (ok and user_key): return \n        self.message_input.clear()\n        try:\n            vigenere_encrypted_text = vigenere_encrypt(message_text, user_key)\n            vigenere_encrypted_bytes = vigenere_encrypted_text.encode('utf-8')\n            \n            whitemist_encrypted_string = encrypt_whitemist(vigenere_encrypted_bytes, user_key, is_text=True)\n            \n            data_bytes_for_aes = whitemist_encrypted_string.encode('utf-8')\n            encrypted_payload_bytes = self.session_crypto.encrypt(data_bytes_for_aes)\n            metadata = { \n                'type': 'text', \n                'sender': self.current_user, \n                'recipient': self.recipient_username, \n                'data': encrypted_payload_bytes.decode('utf-8'), \n                'vigenere_key_debug': user_key,\n                'db_timestamp': datetime.now(timezone.utc).astimezone().isoformat()\n            }\n            self.message_manager.save_message(self.chat_id, metadata)\n            message_id = self.get_message_id(metadata)\n            self.save_to_cache(message_id, message_text)\n            self.refresh_chat_display()\n            \n        except Exception as e: \n            self.add_message_to_display(\"error\", metadata=None, error_text=f\"--- Error Super Enkripsi: {e} ---\")\n\n    # --- [FIX: PERBAIKAN ENKRIPSI STEGANO DENGAN HEADER] ---\n    def handle_attach_image_stegano(self):\n        message_to_hide = self.message_input.text()\n        if not message_to_hide:\n            QMessageBox.warning(self, \"Error\", \"Tulis dulu pesan di kotak teks untuk disembunyikan ke gambar.\")\n            return\n        file_path, _ = QFileDialog.getOpenFileName(self, \"Pilih Gambar Pembawa (.png)\", \"\", \"Images (*.png)\")\n        if not file_path: return\n        try:\n            file_size = os.path.getsize(file_path)\n            if file_size > self.MAX_FILE_SIZE:\n                QMessageBox.warning(self, \"File Terlalu Besar\", f\"Ukuran file ({file_size // 1024} KB) melebihi batas 2MB ({self.MAX_FILE_SIZE // 1024} KB).\")\n                return\n        except OSError as e: QMessageBox.critical(self, \"Error\", f\"Tidak dapat membaca file: {e}\")\n        \n        text_key, ok = QInputDialog.getText(self, \"Kunci Steganografi\", \"Masukkan Kunci VIGENERE untuk teks yang akan disembunyikan:\")\n        if not (ok and text_key): return\n        \n        if not os.path.exists(self.temp_stegano_dir): os.makedirs(self.temp_stegano_dir)\n        base_filename = os.path.basename(file_path)\n        temp_filename = os.path.join(self.temp_stegano_dir, f\"stego_{uuid.uuid4()}.png\") \n        \n        try:\n            # 1. Enkripsi Pesan (Vigenere)\n            encrypted_text_raw = vigenere_encrypt(message_to_hide, text_key)\n            \n            # --- [FIX PENTING: BASE64 ENCODING] ---\n            # Ubah karakter aneh Vigenere menjadi Base64 yang aman untuk Stegano\n            safe_payload = base64.b64encode(encrypted_text_raw.encode('utf-8')).decode('utf-8')\n            \n            # 2. Buat Header Panjang\n            msg_len = len(safe_payload)\n            header = f\"<LEN:{msg_len:010d}>\"\n            \n            # 3. Gabungkan: Header + Base64 Payload + Delimiter\n            payload_final = header + safe_payload + \"|||END_MORSZ|||\"\n            # --------------------------------------\n            \n            # 4. Sembunyikan ke Gambar\n            secret_image = lsb.hide(file_path, payload_final)\n            secret_image.save(temp_filename)\n            \n            self.add_message_to_display(\"error\", metadata=None, error_text=f\"--- Mengunggah {base_filename}... ---\")\n            \n            # Upload Logic (Sama seperti sebelumnya)\n            with open(temp_filename, \"rb\") as f:\n                files = {'file': (base_filename, f, 'image/png')}\n                upload_url = f\"{self.api_url}/upload_file/{self.chat_id}\"\n                response = requests.post(upload_url, files=files, timeout=30)\n            \n            if response.status_code != 200 or not response.json().get(\"success\"):\n                if response.status_code == 413: raise Exception(f\"Gagal unggah: {response.json().get('message')}\")\n                raise Exception(f\"Gagal mengunggah file: {response.json().get('message', 'Error tidak diketahui')}\")\n                \n            file_id = response.json().get(\"file_id\")\n            metadata = { \n                'type': 'stegano', \n                'sender': self.current_user, \n                'recipient': self.recipient_username, \n                'data': None, \n                'file_id': file_id, \n                'filename': base_filename, \n                'text_key_debug': text_key, # Debugging help\n                'db_timestamp': datetime.now(timezone.utc).astimezone().isoformat()\n            }\n            self.message_manager.save_message(self.chat_id, metadata)\n            \n            # Simpan ke cache lokal agar langsung tampil tanpa download ulang\n            message_id = self.get_message_id(metadata)\n            cached_stego_path = os.path.join(self.temp_stegano_dir, file_id)\n            try:\n                if not os.path.exists(cached_stego_path):\n                    import shutil\n                    shutil.copy(temp_filename, cached_stego_path)\n            except: pass\n            \n            cache_data = {\"text\": message_to_hide, \"image_path\": cached_stego_path} \n            self.save_to_cache(message_id, cache_data)\n\n            self.refresh_chat_display()\n            self.message_input.clear()\n            os.remove(temp_filename)\n            \n        except Exception as e:\n            self.add_message_to_display(\"error\", metadata=None, error_text=f\"--- Error Steganografi/Upload: {e} ---\")\n            if os.path.exists(temp_filename): os.remove(temp_filename)\n            \n    def handle_attach_file(self):\n        file_path, _ = QFileDialog.getOpenFileName(self, \"Pilih File Untuk Dienkripsi\", \"\", \"All Files (*.*)\")\n        if not file_path: return\n        try:\n            file_size = os.path.getsize(file_path)\n            if file_size > self.MAX_FILE_SIZE:\n                QMessageBox.warning(self, \"File Terlalu Besar\", f\"Ukuran file ({file_size // 1024} KB) melebihi batas 2MB ({self.MAX_FILE_SIZE // 1024} KB).\")\n                return\n        except OSError as e: QMessageBox.critical(self, \"Error\", f\"Tidak dapat membaca file: {e}\")\n        methods = [\"AES (Modern)\", \"White-Mist (Eksperimental)\"]\n        method, ok = QInputDialog.getItem(self, \"Pilih Metode Enkripsi\", \"Metode:\", methods, 0, False)\n        if not ok: return\n        key, ok = QInputDialog.getText(self, f\"Kunci Enkripsi ({method})\", f\"Masukkan Kunci untuk {method}:\", QLineEdit.Password)\n        if not (ok and key): return\n        try:\n            with open(file_path, \"rb\") as f: data_bytes = f.read()\n            filename = os.path.basename(file_path)\n            encrypted_payload_bytes = None; metadata = {}\n            if method == \"AES (Modern)\":\n                temp_crypto = CryptoEngine(key); encrypted_payload_bytes = temp_crypto.encrypt(data_bytes)\n                metadata = { 'type': 'file', 'sender': self.current_user, 'recipient': self.recipient_username, 'data': None, 'encryption_method': 'aes', 'aes_key_debug': key, 'filename': filename }\n            elif method == \"White-Mist (Eksperimental)\":\n                encrypted_string = encrypt_whitemist(data_bytes, key); encrypted_payload_bytes = encrypted_string.encode('utf-8')\n                metadata = { 'type': 'file', 'sender': self.current_user, 'recipient': self.recipient_username, 'data': None, 'encryption_method': 'whitemist', 'aes_key_debug': key, 'filename': filename }\n            else: return \n            \n            self.add_message_to_display(\"error\", metadata=None, error_text=f\"--- Mengunggah {filename} ({method})... ---\")\n            \n            files = {'file': (f\"{filename}.enc\", encrypted_payload_bytes, 'application/octet-stream')}\n            upload_url = f\"{self.api_url}/upload_file/{self.chat_id}\"\n            response = requests.post(upload_url, files=files, timeout=60)\n            if response.status_code != 200 or not response.json().get(\"success\"):\n                if response.status_code == 413: raise Exception(f\"Gagal unggah: {response.json().get('message')}\")\n                raise Exception(f\"Gagal mengunggah file: {response.json().get('message', 'Error tidak diketahui')}\")\n            file_id = response.json().get(\"file_id\")\n            metadata['file_id'] = file_id \n            metadata['db_timestamp'] = datetime.now(timezone.utc).astimezone().isoformat()\n            \n            self.message_manager.save_message(self.chat_id, metadata)\n            \n            self.refresh_chat_display()\n            \n        except Exception as e: \n            self.add_message_to_display(\"error\", metadata=None, error_text=f\"--- Error File Encryption/Upload: {e} ---\")\n\n    def show_loading_dialog(self, filename):\n        dialog = QDialog(self)\n        dialog.setModal(True)\n        dialog.setWindowTitle(\"Mengunduh...\")\n        dialog.setStyleSheet(f\"background-color: {self.COLOR_BACKGROUND}; color: {self.COLOR_TEXT}; font-size: 14px;\")\n        layout = QVBoxLayout()\n        label = QLabel(f\"Sedang mengunduh file:\\n{filename}\\n\\nHarap tunggu...\")\n        label.setAlignment(Qt.AlignmentFlag.AlignCenter)\n        layout.addWidget(label)\n        dialog.setLayout(layout)\n        dialog.setFixedSize(300, 150)\n        \n        dialog.show()\n        QApplication.processEvents() \n        return dialog\n\n    def on_chat_item_clicked(self, item):\n        metadata = item.data(Qt.UserRole)\n        if not metadata: return\n        \n        msg_box = QMessageBox(self)\n        msg_type = metadata.get('type')\n        file_id = metadata.get('file_id')\n        \n        try:\n            if msg_type == 'text':\n                message_id = self.get_message_id(metadata)\n                encrypted_data_b64 = metadata.get('data')\n                if not encrypted_data_b64:\n                    QMessageBox.information(self, \"Info\", \"Pesan ini sudah dalam bentuk teks biasa.\")\n                    return\n                encrypted_data_b64 = encrypted_data_b64.encode('utf-8')\n                key, ok = QInputDialog.getText(self, \"Dekripsi Teks\", \"Masukkan Kunci (White-Mist + Vigenere):\")\n                if ok and key:\n                    decrypted_text = \"\"\n                    try:\n                        decrypted_bytes_from_aes = self.session_crypto.decrypt(encrypted_data_b64)\n                        whitemist_encrypted_string = decrypted_bytes_from_aes.decode('utf-8')\n                        try:\n                            vigenere_encrypted_bytes = decrypt_whitemist(whitemist_encrypted_string, key, is_text=True)\n                            vigenere_encrypted_text = vigenere_encrypted_bytes.decode('utf-8')\n                        except Exception as e_whitemist:\n                            print(f\"Error WhiteMist/b64: {e_whitemist}\")\n                            vigenere_encrypted_text = whitemist_encrypted_string \n                        decrypted_text = vigenere_decrypt(vigenere_encrypted_text, key)\n                    except Exception as e_aes:\n                        print(f\"Error AES: {e_aes}\")\n                        decrypted_text = f\"[DEKRIPSI GAGAL: Data korup atau kunci sesi salah.]\"\n                    if message_id: \n                        self.save_to_cache(message_id, decrypted_text)\n                    new_widget = self.create_chat_bubble(\"received\" if metadata['sender'] != self.current_user else \"sent\", metadata, decrypted_text, item)\n                    new_widget.layout().activate()\n                    new_widget.adjustSize()\n                    real_size = new_widget.size()\n                    real_size.setHeight(real_size.height() + 10)\n                    item.setSizeHint(real_size)\n                    self.chat_display.setItemWidget(item, new_widget)\n\n            elif msg_type == 'file' and file_id:\n                local_encrypted_path = os.path.join(self.temp_download_dir, file_id)\n                filename = metadata.get('filename', 'file.enc')\n                if not os.path.exists(local_encrypted_path):\n                    loading_dialog = self.show_loading_dialog(filename)\n                    download_url = f\"{self.api_url}/download_file/{self.chat_id}/{file_id}\"\n                    response = requests.get(download_url, timeout=60)\n                    loading_dialog.close() \n                    if response.status_code != 200: raise Exception(\"Gagal mengunduh file dari server.\")\n                    with open(local_encrypted_path, \"wb\") as f: f.write(response.content)\n                    self.add_message_to_display(\"error\", metadata=None, error_text=f\"--- Unduhan Selesai. Disimpan di cache. ---\")\n                else:\n                    self.add_message_to_display(\"error\", metadata=None, error_text=f\"--- Membuka {filename} dari cache... ---\")\n                key, ok = QInputDialog.getText(self, \"Dekripsi File\", \"Masukkan Kunci untuk file ini:\", QLineEdit.Password)\n                if not (ok and key): return\n                with open(local_encrypted_path, \"rb\") as f: encrypted_bytes = f.read()\n                decrypted_bytes = None; method = metadata.get('encryption_method', 'aes')\n                if method == 'aes':\n                    self.add_message_to_display(\"error\", metadata=None, error_text=f\"--- Mendekripsi (AES)... ---\")\n                    temp_crypto = CryptoEngine(key); decrypted_bytes = temp_crypto.decrypt(encrypted_bytes)\n                elif method == 'whitemist':\n                    self.add_message_to_display(\"error\", metadata=None, error_text=f\"--- Mendekripsi (White-Mist)... ---\")\n                    encrypted_string = encrypted_bytes.decode('utf-8'); \n                    decrypted_bytes = decrypt_whitemist(encrypted_string, key)\n                else: raise ValueError(f\"Metode enkripsi '{method}' tidak dikenal.\")\n                decrypted_path = os.path.join(self.temp_decrypted_dir, f\"DECRYPTED_{filename}\")\n                with open(decrypted_path, \"wb\") as f: f.write(decrypted_bytes)\n                msg_box.setWindowTitle(\"File Didekripsi\"); msg_box.setText(f\"File '{filename}' ({method}) berhasil didekripsi!\")\n                msg_box.setInformativeText(f\"Disimpan di: {decrypted_path}\"); msg_box.exec()\n\n            # --- [FIX: PERBAIKAN DEKRIPSI STEGANO DENGAN HEADER] ---\n            elif msg_type == 'stegano' and file_id:\n                filename = metadata.get('filename', f\"{file_id}.png\")\n                local_stegano_path = os.path.join(self.temp_stegano_dir, file_id) \n                \n                # Download logic (sama)\n                if not os.path.exists(local_stegano_path):\n                    loading_dialog = self.show_loading_dialog(filename)\n                    download_url = f\"{self.api_url}/download_file/{self.chat_id}/{file_id}\"\n                    try:\n                        response = requests.get(download_url, timeout=60)\n                        loading_dialog.close() \n                        if response.status_code != 200: raise Exception(\"Gagal unduh gambar.\")\n                        with open(local_stegano_path, \"wb\") as f: f.write(response.content)\n                    except:\n                        loading_dialog.close(); raise\n                \n                msg_box.setWindowTitle(\"Pesan Gambar\")\n                pixmap = QPixmap(local_stegano_path).scaled(400, 400, Qt.KeepAspectRatio, Qt.SmoothTransformation)\n                msg_box.setIconPixmap(pixmap)\n                msg_box.setText(\"Gambar Steganografi diterima.\")\n                decrypt_button = msg_box.addButton(\"Dekripsi Pesan\", QMessageBox.AcceptRole)\n                msg_box.addButton(QMessageBox.Close); msg_box.exec()\n                \n                if msg_box.clickedButton() == decrypt_button:\n                    key, ok = QInputDialog.getText(self, \"Dekripsi\", \"Masukkan Kunci VIGENERE:\")\n                    if ok and key:\n                        try:\n                            # 1. Ambil data mentah dari gambar\n                            raw_revealed = lsb.reveal(local_stegano_path)\n                            if not raw_revealed: raise ValueError(\"Gambar kosong/bukan stegano.\")\n                            \n                            clean_payload = raw_revealed\n                            \n                            # 2. Parsing Header <LEN:...>\n                            if raw_revealed.startswith(\"<LEN:\") and len(raw_revealed) >= 16:\n                                len_str = raw_revealed[5:15]\n                                expected_len = int(len_str)\n                                start_idx = 16\n                                end_idx = 16 + expected_len\n                                clean_payload = raw_revealed[start_idx:end_idx]\n                            elif \"|||END_MORSZ|||\" in raw_revealed:\n                                clean_payload = raw_revealed.split(\"|||END_MORSZ|||\")[0]\n                            \n                            # --- [FIX PENTING: DECODE BASE64 DULU] ---\n                            # Sebelum didekripsi Vigenere, kembalikan dari Base64\n                            try:\n                                # Coba decode base64. Jika gagal, mungkin format lama (langsung vigenere)\n                                vigenere_ciphertext = base64.b64decode(clean_payload).decode('utf-8')\n                            except Exception:\n                                # Fallback untuk pesan lama yang belum pakai Base64\n                                print(\"Gagal Base64 decode, mencoba raw text (legacy)...\")\n                                vigenere_ciphertext = clean_payload\n\n                            # 3. Dekripsi Vigenere\n                            decrypted_message = vigenere_decrypt(vigenere_ciphertext, key)\n                            \n                            # Simpan Cache & Tampilkan\n                            message_id = self.get_message_id(metadata)\n                            if message_id:\n                                cache_data = {\"text\": decrypted_message, \"image_path\": local_stegano_path}\n                                self.save_to_cache(message_id, cache_data)\n                            \n                            # --- [MODIFIKASI: Scrollable Dialog] ---\n                            result_dialog = QDialog(self)\n                            result_dialog.setWindowTitle(\"Pesan Tersembunyi\")\n                            result_dialog.resize(500, 400)\n                            res_layout = QVBoxLayout(result_dialog)\n                            \n                            info_lbl = QLabel(\"Isi Pesan (Decrypted):\")\n                            info_lbl.setStyleSheet(f\"color: {self.COLOR_GOLD}; font-weight: bold;\")\n                            res_layout.addWidget(info_lbl)\n                            \n                            text_area = QTextEdit()\n                            text_area.setPlainText(decrypted_message)\n                            text_area.setReadOnly(True)\n                            text_area.setStyleSheet(f\"background-color: {self.COLOR_PANE_LEFT}; color: {self.COLOR_TEXT}; border: 1px solid {self.COLOR_GOLD};\")\n                            res_layout.addWidget(text_area)\n                            \n                            close_btn = QPushButton(\"Tutup\")\n                            close_btn.setStyleSheet(self.button_style(base=self.COLOR_RED, hover=self.COLOR_RED_HOVER, pressed=self.COLOR_RED_PRESSED))\n                            close_btn.clicked.connect(result_dialog.accept)\n                            res_layout.addWidget(close_btn)\n                            \n                            result_dialog.exec()\n                            # ---------------------------------------\n                            \n                            # Update UI Bubble\n                            new_widget = self.create_chat_bubble(\"received\" if metadata['sender'] != self.current_user else \"sent\", metadata, cache_data, item)\n                            new_widget.layout().activate(); new_widget.adjustSize()\n                            real_size = new_widget.size(); real_size.setHeight(real_size.height() + 10)\n                            item.setSizeHint(real_size); self.chat_display.setItemWidget(item, new_widget)\n                            \n                        except Exception as e:\n                            QMessageBox.critical(self, \"Gagal Dekripsi\", f\"Error: {e}\\nKey mungkin salah atau data korup.\")\n\n        except Exception as e:\n            print(f\"Error di on_chat_item_clicked: {e}\")\n            debug_key = metadata.get('aes_key_debug') or metadata.get('text_key_debug', 'TIDAK DIKETAHUI')\n            QMessageBox.critical(self, \"Error Dekripsi\", f\"Terjadi error: {e}\\n\\n(Debug: Kunci yg benar mungkin '{debug_key}')\")\n\n    def create_chat_bubble(self, align, metadata, cached_data=None, item=None):\n        bubble_container = QWidget()\n        container_layout = QHBoxLayout(bubble_container)\n        container_layout.setContentsMargins(5, 5, 5, 5)\n        container_layout.setSpacing(0)\n\n        bubble_frame = QFrame()\n        bubble_frame.setFrameShape(QFrame.Shape.StyledPanel)\n        bubble_frame.setFrameShadow(QFrame.Shadow.Plain)\n        bubble_frame.setLineWidth(0)\n        \n        bubble_frame.setSizePolicy(QSizePolicy.Policy.Minimum, QSizePolicy.Policy.Minimum)\n        bubble_frame.setMinimumWidth(self.width() * 0.3)\n        bubble_frame.setMaximumWidth(self.width() * 0.7)\n\n        bubble_content_layout = QVBoxLayout(bubble_frame)\n        bubble_content_layout.setContentsMargins(12, 10, 12, 8)\n        bubble_content_layout.setSpacing(8)\n        \n        msg_type = metadata.get('type', 'unknown')\n        content_max_width = (self.width() * 0.7) - 24\n        \n        if align == \"sent\":\n            name_label = QLabel(\"YOU\")\n            name_label.setFont(QFont(\"Segoe UI\", 10, QFont.Bold))\n            name_label.setStyleSheet(f\"color: {self.COLOR_GOLD};\")\n            bubble_content_layout.addWidget(name_label)\n        elif align == \"received\":\n            prefix = metadata.get('sender', 'Unknown')\n            name_label = QLabel(prefix)\n            name_label.setFont(QFont(\"Segoe UI\", 10, QFont.Bold))\n            name_label.setStyleSheet(f\"color: {self.COLOR_GOLD};\")\n            bubble_content_layout.addWidget(name_label)\n        \n        if msg_type == 'text':\n            display_text = cached_data if cached_data else \"[Pesan Teks Super-Terenkripsi]\"\n            content_label = QLabel(display_text)\n            content_label.setWordWrap(True)\n            content_label.setMaximumWidth(content_max_width)\n            content_label.setStyleSheet(f\"color: {self.COLOR_TEXT}; font-size: 14px;\")\n            content_label.setTextInteractionFlags(Qt.TextInteractionFlag.TextSelectableByMouse)\n            content_label.setMinimumHeight(30)\n            bubble_",
    "image_path": "x:\\newLDU\\local_data\\temp_stegano\\a87e49a6-ced1-4014-93c3-1e2f8804ceb2.png"
  }
}